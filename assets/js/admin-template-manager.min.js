
jQuery(document).ready(function($) {

    epblSetupAjaxInProgressDialog();

    var clickedOnElement;
    var isPreset = false;

    // COPY PRESET
    $('.epbl-tm-section-preset__header__controls__copy').on( 'click', function(e) {
        e.preventDefault();
        clickedOnElement = $(this);
        isPreset = true;
        epblSendRequest( 'epbl-template-mgr-copy', 'Copying preset...', epblHandleCopyResponse );
    });
    // COPY TEMPLATE
    $('.epbl-tm-section-template__header__controls__copy').on( 'click', function(e) {
        e.preventDefault();
        clickedOnElement = $(this);
        isPreset = false;
        epblSendRequest( 'epbl-template-mgr-copy', 'Copying template...', epblHandleCopyResponse );
    });
    function epblHandleCopyResponse( templateResult ) {
        let clonedBlock = isPreset ? $('.epbl-tm-section-template').first().clone(true) : clickedOnElement.closest('.epbl-tm-preset-template').clone();
        clonedBlock.attr('data-template-id', templateResult['template_id']);
        clonedBlock.find('.epbl-tm-section-template__header__info__name').text(templateResult['template_name']);
        clonedBlock.find('.epbl-tm-section-template__header__info__disc').text(templateResult['template_description']);

        if ( isPreset ) {
            let blockPreview = clickedOnElement.closest('.epbl-tm-section-preset').find('.epbl-tm-section-preset__preview').clone();
            clonedBlock.find('.epbl-tm-section-template__preview').html(blockPreview);
        }

        clonedBlock.css('display', 'block');

        $('.epbl-template-manager-container').append( clonedBlock );
    }

    // RENAME TEMPLATE
    $('.epbl-tm-section-template__header__controls__rename').on( 'click', function(e) {
        e.preventDefault();
        clickedOnElement = $(this);
        $('#epbl_tm_template_name_change_dialog').css('display', 'block');
    });
    $('#epbl_tm_submit_name_description').on( 'click', function(e) {
        e.preventDefault();
        epblSendRequest( 'epbl-template-mgr-rename', 'Updating template...', epblHandleRenameResponse, $('#epbl_tm_template_name').val(), $('#epbl_tm_template_description').val() );
    });
    function epblHandleRenameResponse( templateResult ) {
        clickedOnElement.closest('.epbl-tm-preset-template').find('.epbl-tm-section-template__header__info__name').text(templateResult['template_name']);
        clickedOnElement.closest('.epbl-tm-preset-template').find('.epbl-tm-section-template__header__info__disc').text(templateResult['template_description']);

        $('#epbl_tm_template_name').text('');
        $('#epbl_tm_template_description').text('');
        $('#epbl_tm_template_name_change_dialog').css('display', 'none');
    }

    // DELETE TEMPLATE
    $('.epbl-tm-section-template__header__controls__delete').on( 'click', function(e) {
        e.preventDefault();
        clickedOnElement = $(this);
        epblSendRequest( 'epbl-template-mgr-delete', 'Deleting template...', epblHandleDeleteResponse );
    });
    function epblHandleDeleteResponse() {
        clickedOnElement.closest('.epbl-tm-preset-template').remove();
    }


    /*****************************************************************************
     /  UTILITY FUNCTIONS
     /*****************************************************************************/

    function epblSendRequest( action, message, handler, templateName='', templateDescription='' ) {

        // noinspection JSUnresolvedVariable
        let postData = {
            action: action,
            nonce: $('#_wpnonce_epbl_template_manager_action').val(),
            templateId: epbl_get_selected_template_id(),
            blockType: epbl_get_selected_type(),
            blockName: epbl_get_block_name(),
            templateName: templateName,
            templateDescription: templateDescription
        };

        epblSendAjaxRequest( 'POST', postData, message, handler );
    }

    function epbl_get_block_name() {
        return $('.epbl-template-manager-container').data('block-name');
    }

    function epbl_get_selected_template_id() {
        return clickedOnElement.closest('.epbl-tm-preset-template').attr('data-template-id');
    }

    function epbl_get_selected_type() {
        return clickedOnElement.closest('.epbl-tm-preset-template').attr('data-template-type');
    }

    function epblSendAjaxRequest(ajax_type, postData, action_msg, handler ) {

        let msg;
        let ajaxResponse = '';

        $.ajax({
            type: ajax_type,
            dataType: 'json',
            data: postData,
            url: ajaxurl,
            beforeSend: function (xhr)
            {
                if ( ! $("#epbl-ajax-in-progress").hasClass("ui-dialog-content") ) {
                    epblSetupAjaxInProgressDialog();
                }
                //noinspection JSUnresolvedVariable
                $('#epbl-ajax-in-progress').text(action_msg).dialog('open');
            }
        }).done(function (response) {

            ajaxResponse = ( response ? response : '' );
            if (  ajaxResponse.error || ajaxResponse.status !== 'success' ) {
                //noinspection JSUnresolvedVariable,JSUnusedAssignment
                msg = ajaxResponse.message ? ajaxResponse.message : epblAdminNotification('', 'Document Blocks: Error occurred. Please try again later. (L01)', 'error');
                return;
            }

        }).fail(function (response, textStatus, error) {
            msg = ( error ? ' [' + error + ']' : 'unknown error' );
            msg = epblAdminNotification('Document Blocks: Error occurred. Please try again later. (L02)', msg, 'error');
        }).always(function () {

            epblCloseDialog();

            if ( msg ) {
                $('.epbl-top-notice-message').replaceWith(msg);
                $( "html, body" ).animate( {scrollTop: 0}, "slow" );
            }

            if ( ajaxResponse === '' ) {
                return;
            }

            // noinspection JSUnresolvedVariable
            let output = typeof ajaxResponse.template_result !== 'undefined' && ajaxResponse.template_result ? ajaxResponse.template_result :
                epblAdminNotification('', 'Please reload the page and try again (L37).', 'error');

            if ( handler ) {
                handler(output);
            }
        });
    }

    // SHOW INFO MESSAGES
    function epblAdminNotification( $title, $message , $type ) {
        return '<div class="epbl-top-notice-message">' +
            '<div class="contents">' +
            '<span class="' + $type + '">' +
            ($title ? '<h4>'+$title+'</h4>' : '' ) +
            ($message ? $message : '') +
            '</span>' +
            '</div>' +
            '</div>';
    }

    // SAVE AJAX-IN-PROGRESS DIALOG
    function epblSetupAjaxInProgressDialog() {
        $('#epbl-ajax-in-progress').dialog({
            resizable: false,
            height: 70,
            width: 200,
            modal: false,
            autoOpen: false
        }).hide();
    }

    function epblCloseDialog() {
        if ($("#epbl-ajax-in-progress").hasClass("ui-dialog-content") && $("#epbl-ajax-in-progress").dialog("isOpen")) {
            $('#epbl-ajax-in-progress').dialog('close');
        }
    }


    if( $( '#epbl-getting-started-container').length > 0 ){

        $( '.epbl-tm-tab-nav-container li' ).on( 'click', function(){

            let id = $( this ).attr( 'id' );

            console.log( id );
            //Hide Panels
            $( '.epbl-tm-panel' ).hide();

            //Remove active tab class
            $( '.epbl-tm-tab-nav-container li' ).removeClass( 'epbl-active-tab' );
            //Show Panel based on selected tab
            $( '#'+id+'-panel' ).show();

            //Add active tab class
            $( this ).addClass( 'epbl-active-tab' );

        });

    }

});
